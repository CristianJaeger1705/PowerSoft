<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Powersoft - Estados Financieros</title>
  <link rel="stylesheet" href="estilos.css" />
</head>
<body>
  <div class="topbar"><div>Estados financieros</div><div><a href="index.html">Menú</a></div></div>
  <main class="container">
    <section class="card">
      <h3>Opciones</h3>
      <button id="calcGlobal">Generar Balance</button>
      <button id="calcClasificado">Generar Balance Clasificado</button>
      <button id="calcEr">Generar Estado de Resultados</button>
      <button id="calcCif">Calcular CIF de Software</button>
      <button id="calcAnalitico">Estado Analítico Detallado</button>
      <button id="calcMayor">Generar Libro Mayor</button>
      <button id="calcCierre">Cierre Contable</button>
    </section>

    <section class="card">
      <h3>Resultado</h3>
      <div id="output"></div>
    </section>
  </main>

  <script>
    const API = 'http://localhost:3000';
    if (!sessionStorage.getItem('ps_user')) location.href='login.html';

    async function loadData(){
      const [accRes, jRes] = await Promise.all([fetch(API + '/accounts'), fetch(API + '/journals')]);
      const accounts = await accRes.json();
      const journals = await jRes.json();
      return {accounts, journals};
    }

    // calcula saldo por cuenta (debe - haber)
    function computeBalances(accounts, journals) {
      const balances = {};
      for (const a of accounts) balances[a.id] = { account: a, balance: 0 };
      for (const j of journals) {
        for (const e of j.entries) {
          if (!balances[e.accountId]) continue;
          balances[e.accountId].balance += (e.debit || 0) - (e.credit || 0);
        }
      }
      return balances;
    }

    // Balance Global (totales)
    document.getElementById('calcGlobal').addEventListener('click', async () => {
      const {accounts, journals} = await loadData();
      const balances = computeBalances(accounts, journals);
      let activo = 0, pasivo = 0, patrimonio = 0;
      for (const id in balances) {
        const acc = balances[id].account;
        const b = balances[id].balance;
        if (acc.type === 'activo') activo += b;
        if (acc.type === 'pasivo') pasivo += b;
        if (acc.type === 'patrimonio') patrimonio += b;
        // ingresos, costos y gastos influyen en patrimonio por cierre (aquí no cerramos)
      }
      const out = document.getElementById('output');
      out.innerHTML = `<h4>Balance</h4>
        <table><tr><th>Rubro</th><th>Monto</th></tr>
        <tr><td>Activo Total</td><td>${activo.toFixed(2)}</td></tr>
        <tr><td>Pasivo Total</td><td>${pasivo.toFixed(2)}</td></tr>
        <tr><td>Patrimonio</td><td>${patrimonio.toFixed(2)}</td></tr>
        </table>`;
    });

    // Balance Clasificado
    document.getElementById('calcClasificado').addEventListener('click', async ()=>{
      const {accounts, journals} = await loadData();
      const balances = computeBalances(accounts, journals);
      // agrupar por tipo y subtipo
      const grouped = {};
      for (const id in balances) {
        const acc = balances[id].account;
        const b = balances[id].balance;
        const key = acc.type + (acc.subtype ? '|' + acc.subtype : '');
        if (!grouped[key]) grouped[key] = 0;
        grouped[key] += b;
      }
      const out = document.getElementById('output');
      let html = `<h4>Balance - Clasificado</h4><table><tr><th>Rubro</th><th>Monto</th></tr>`;
      for (const k in grouped) {
        html += `<tr><td>${k.replace('|',' - ')}</td><td>${grouped[k].toFixed(2)}</td></tr>`;
      }
      html += `</table>`;
      out.innerHTML = html;
    });

    // Estado de Resultados (Ingresos - Costos - Gastos)
    document.getElementById('calcEr').addEventListener('click', async ()=>{
      const {accounts, journals} = await loadData();
      const balances = computeBalances(accounts, journals);
      let ingresos = 0, costos = 0, gastos = 0;
      for (const id in balances) {
        const acc = balances[id].account;
        const b = balances[id].balance;
        if (acc.type === 'ingreso') ingresos += -b; // usualmente ingresos tienen saldo acreedor; ajustamos señal
        if (acc.type === 'costo') costos += b;
        if (acc.type === 'gasto') gastos += b;
      }
      const utilidad = ingresos - costos - gastos;
      const out = document.getElementById('output');
      out.innerHTML = `<h4>Estado de Resultados</h4>
        <table><tr><td>Ingresos</td><td>${ingresos.toFixed(2)}</td></tr>
        <tr><td>(-) Costos</td><td>${costos.toFixed(2)}</td></tr>
        <tr><td>(-) Gastos</td><td>${gastos.toFixed(2)}</td></tr>
        <tr><th>Utilidad Neta</th><th>${utilidad.toFixed(2)}</th></tr></table>`;
    });

    // Cálculo de CIF para Software
    document.getElementById('calcCif').addEventListener('click', async ()=>{
      const {accounts, journals} = await loadData();
      const balances = computeBalances(accounts, journals);
      
      // Identificar costos indirectos de fabricación de software
      let cifSoftware = 0;
      let cifDetalle = [];
      
      for (const id in balances) {
        const acc = balances[id].account;
        const b = balances[id].balance;
        
        // Consideramos como CIF de software: salarios indirectos, licencias, hosting, etc.
        if ((acc.type === 'gasto' || acc.type === 'costo_software') && 
            (acc.name.includes('Sueldos') || acc.name.includes('Licencias') || 
             acc.name.includes('Hosting') || acc.name.includes('Alquiler') || 
             acc.name.includes('Servicios') || acc.name.includes('Administración') ||
             acc.name.includes('Publicidad'))) {
          cifSoftware += b;
          cifDetalle.push({nombre: acc.name, monto: b});
        }
      }
      
      const out = document.getElementById('output');
      let html = `<h4>CIF (Costos Indirectos de Fabricación) - Software</h4>
                  <table><tr><th>Concepto</th><th>Monto</th></tr>`;
      
      cifDetalle.forEach(item => {
        html += `<tr><td>${item.nombre}</td><td>${item.monto.toFixed(2)}</td></tr>`;
      });
      
      html += `<tr><th>Total CIF Software</th><th>${cifSoftware.toFixed(2)}</th></tr></table>`;
      
      // Calcular costo por punto de función (si hay datos)
      const journalsWithFP = journals.filter(j => j.functionPoints && j.functionPoints > 0);
      if (journalsWithFP.length > 0) {
        const totalFunctionPoints = journalsWithFP.reduce((sum, j) => sum + j.functionPoints, 0);
        const costoPorPunto = cifSoftware / totalFunctionPoints;
        
        html += `<h4>Análisis por Puntos de Función</h4>
                 <p>Total Puntos de Función: ${totalFunctionPoints}</p>
                 <p>Costo por Punto de Función: $${costoPorPunto.toFixed(2)}</p>`;
      }
      
      out.innerHTML = html;
    });

    // Estado Analítico Detallado
    document.getElementById('calcAnalitico').addEventListener('click', async ()=>{
      const {accounts, journals} = await loadData();
      const balances = computeBalances(accounts, journals);
      
      let html = `<h4>Estado Analítico Detallado</h4>
                  <table><tr><th>Cuenta</th><th>Monto</th><th>Tipo</th></tr>`;
      
      // Agrupar por tipo de cuenta
      const tipos = {
        activo: [],
        pasivo: [],
        patrimonio: [],
        ingreso: [],
        costo: [],
        gasto: [],
        costo_software: []
      };
      
      for (const id in balances) {
        const acc = balances[id].account;
        const b = balances[id].balance;
        const monto = (acc.type === 'ingreso') ? -b : b; // Ajustar para ingresos
        
        if (tipos[acc.type]) {
          tipos[acc.type].push({nombre: acc.name, monto});
        }
      }
      
      // Mostrar cada tipo
      for (const tipo in tipos) {
        if (tipos[tipo].length > 0) {
          html += `<tr><td colspan="3" style="background-color:#f0f0f0; font-weight:bold">${tipo.toUpperCase()}</td></tr>`;
          
          let subtotal = 0;
          tipos[tipo].forEach(item => {
            html += `<tr><td>${item.nombre}</td><td>${item.monto.toFixed(2)}</td><td>${tipo}</td></tr>`;
            subtotal += item.monto;
          });
          
          html += `<tr><td><strong>Subtotal ${tipo}</strong></td><td><strong>${subtotal.toFixed(2)}</strong></td><td></td></tr>`;
        }
      }
      
      // Calcular utilidad
      const ingresosTotal = tipos.ingreso.reduce((sum, item) => sum + item.monto, 0);
      const costosTotal = tipos.costo.reduce((sum, item) => sum + item.monto, 0);
      const gastosTotal = tipos.gasto.reduce((sum, item) => sum + item.monto, 0);
      const costoSoftwareTotal = tipos.costo_software.reduce((sum, item) => sum + item.monto, 0);
      
      const utilidad = ingresosTotal - costosTotal - gastosTotal - costoSoftwareTotal;
      
      html += `<tr><td colspan="3" style="background-color:#e0e0e0; font-weight:bold">RESUMEN</td></tr>
               <tr><td>Total Ingresos</td><td>${ingresosTotal.toFixed(2)}</td><td></td></tr>
               <tr><td>(-) Costos Directos</td><td>${costosTotal.toFixed(2)}</td><td></td></tr>
               <tr><td>(-) Costos Software</td><td>${costoSoftwareTotal.toFixed(2)}</td><td></td></tr>
               <tr><td>(-) Gastos Operativos</td><td>${gastosTotal.toFixed(2)}</td><td></td></tr>
               <tr><td><strong>UTILIDAD NETA</strong></td><td><strong>${utilidad.toFixed(2)}</strong></td><td></td></tr>
               </table>`;
      
      document.getElementById('output').innerHTML = html;
    });
///////////////////////////////////////////////////////////////////////////////////////////////////

      // Función para generar Libro Mayor con filtros de período
document.getElementById('calcMayor').addEventListener('click', async ()=>{
  const {accounts, journals} = await loadData();
  
  // Crear interfaz de filtros
  let html = `<h4>Libro Mayor - Con Filtros de Período</h4>
              <div class="filtros-periodo">
                <label>Fecha Inicio: <input type="date" id="fechaInicio"></label>
                <label>Fecha Fin: <input type="date" id="fechaFin"></label>
                <label>Mostrar cuentas con saldo cero: 
                  <input type="checkbox" id="mostrarCero" checked>
                </label>
                <button onclick="generarLibroMayorFiltrado()">Generar Reporte</button>
              </div>
              <div id="resultadoMayor"></div>`;
  
  document.getElementById('output').innerHTML = html;
});

// Función para generar el libro mayor filtrado
async function generarLibroMayorFiltrado() {
  const {accounts, journals} = await loadData();
  const fechaInicio = document.getElementById('fechaInicio').value;
  const fechaFin = document.getElementById('fechaFin').value;
  const mostrarCero = document.getElementById('mostrarCero').checked;
  
  let html = `<h4>Libro Mayor ${fechaInicio ? `del ${fechaInicio} al ${fechaFin}` : 'Completo'}</h4>`;
  
  // Filtrar journals por fecha si se especificó
  let journalsFiltrados = journals;
  if (fechaInicio && fechaFin) {
    journalsFiltrados = journals.filter(j => j.date >= fechaInicio && j.date <= fechaFin);
  }
  
  // Ordenar journals por fecha
  journalsFiltrados.sort((a, b) => new Date(a.date) - new Date(b.date));
  
  let totalDebe = 0;
  let totalHaber = 0;
  
  // Para cada cuenta, generar su libro mayor
  for (const account of accounts) {
    const movimientos = [];
    let saldoInicial = 0;
    let saldoFinal = 0;
    
    // Calcular saldo inicial (transacciones antes del período)
    if (fechaInicio) {
      const journalsInicial = journals.filter(j => j.date < fechaInicio);
      for (const journal of journalsInicial) {
        for (const entry of journal.entries) {
          if (entry.accountId === account.id) {
            saldoInicial += (entry.debit || 0) - (entry.credit || 0);
          }
        }
      }
    }
    
    saldoFinal = saldoInicial;
    
    // Buscar transacciones del período
    for (const journal of journalsFiltrados) {
      for (const entry of journal.entries) {
        if (entry.accountId === account.id) {
          const movimiento = {
            fecha: journal.date,
            descripcion: journal.desc,
            debe: entry.debit || 0,
            haber: entry.credit || 0
          };
          
          saldoFinal += movimiento.debe - movimiento.haber;
          movimiento.saldo = saldoFinal;
          
          movimientos.push(movimiento);
          
          totalDebe += movimiento.debe;
          totalHaber += movimiento.haber;
        }
      }
    }
    
    // Mostrar cuenta solo si tiene movimientos o si se solicita mostrar cero
    if (movimientos.length > 0 || (mostrarCero && saldoFinal !== 0)) {
      html += `<div class="cuenta-mayor" style="margin-bottom: 30px; border: 1px solid #ccc; padding: 15px;">
                <h5>${account.code} - ${account.name} (${account.type})</h5>
                <p><strong>Saldo Inicial: ${saldoInicial.toFixed(2)}</strong></p>
                <table style="width: 100%; border-collapse: collapse;">
                  <tr style="background-color: #003366; color: white;">
                    <th style="padding: 8px; border: 1px solid #ccc;">Fecha</th>
                    <th style="padding: 8px; border: 1px solid #ccc;">Descripción</th>
                    <th style="padding: 8px; border: 1px solid #ccc;">Debe</th>
                    <th style="padding: 8px; border: 1px solid #ccc;">Haber</th>
                    <th style="padding: 8px; border: 1px solid #ccc;">Saldo</th>
                  </tr>`;
      
      // Mostrar saldo inicial como primera línea
      if (fechaInicio && saldoInicial !== 0) {
        html += `<tr>
                  <td style="padding: 8px; border: 1px solid #ccc;">${fechaInicio}</td>
                  <td style="padding: 8px; border: 1px solid #ccc;">Saldo Inicial</td>
                  <td style="padding: 8px; border: 1px solid #ccc;"></td>
                  <td style="padding: 8px; border: 1px solid #ccc;"></td>
                  <td style="padding: 8px; border: 1px solid #ccc;">${saldoInicial.toFixed(2)}</td>
                </tr>`;
      }
      
      // Mostrar movimientos
      for (const mov of movimientos) {
        html += `<tr>
                  <td style="padding: 8px; border: 1px solid #ccc;">${mov.fecha}</td>
                  <td style="padding: 8px; border: 1px solid #ccc;">${mov.descripcion}</td>
                  <td style="padding: 8px; border: 1px solid #ccc;">${mov.debe > 0 ? mov.debe.toFixed(2) : ''}</td>
                  <td style="padding: 8px; border: 1px solid #ccc;">${mov.haber > 0 ? mov.haber.toFixed(2) : ''}</td>
                  <td style="padding: 8px; border: 1px solid #ccc;">${mov.saldo.toFixed(2)}</td>
                </tr>`;
      }
      
      html += `</table>
               <p><strong>Saldo Final: ${saldoFinal.toFixed(2)}</strong></p>
              </div>`;
    }
  }
  
  // Totales generales
  html += `<div style="background-color: #e9f0ff; padding: 15px; margin-top: 20px;">
            <h5>Totales del Período</h5>
            <p>Total Débito: ${totalDebe.toFixed(2)}</p>
            <p>Total Crédito: ${totalHaber.toFixed(2)}</p>
            <p>Diferencia: ${(totalDebe - totalHaber).toFixed(2)}</p>
           </div>`;
  
  document.getElementById('resultadoMayor').innerHTML = html;
}

// Función para Cierre Contable
document.getElementById('calcCierre').addEventListener('click', async ()=>{
  const {accounts, journals} = await loadData();
  
  let html = `<h4>Cierre Contable</h4>
              <div class="cierre-form">
                <label>Período a cerrar (Mes/Año): 
                  <input type="month" id="periodoCierre" required>
                </label>
                <button onclick="realizarCierre()">Realizar Cierre</button>
                <div id="resultadoCierre"></div>
              </div>`;
  
  document.getElementById('output').innerHTML = html;
});

// Función para realizar el cierre contable
async function realizarCierre() {
  const periodo = document.getElementById('periodoCierre').value;
  if (!periodo) {
    alert('Seleccione un período');
    return;
  }
  
  const {accounts, journals} = await loadData();
  const balances = computeBalances(accounts, journals);
  
  // Calcular resultado del ejercicio (Ingresos - Gastos - Costos)
  let totalIngresos = 0;
  let totalGastos = 0;
  let totalCostos = 0;
  let totalCostosSoftware = 0;
  
  for (const id in balances) {
    const acc = balances[id].account;
    const b = balances[id].balance;
    
    if (acc.type === 'ingreso') totalIngresos += -b;
    if (acc.type === 'gasto') totalGastos += b;
    if (acc.type === 'costo') totalCostos += b;
    if (acc.type === 'costo_software') totalCostosSoftware += b;
  }
  
  const resultadoEjercicio = totalIngresos - totalGastos - totalCostos - totalCostosSoftware;
  
  let html = `<h4>Resultado del Cierre - ${periodo}</h4>
              <table>
                <tr><td>Total Ingresos:</td><td>${totalIngresos.toFixed(2)}</td></tr>
                <tr><td>(-) Total Gastos:</td><td>${totalGastos.toFixed(2)}</td></tr>
                <tr><td>(-) Total Costos:</td><td>${totalCostos.toFixed(2)}</td></tr>
                <tr><td>(-) Total Costos Software:</td><td>${totalCostosSoftware.toFixed(2)}</td></tr>
                <tr><th>Resultado del Ejercicio:</th><th>${resultadoEjercicio.toFixed(2)}</th></tr>
              </table>`;
  
  if (resultadoEjercicio !== 0) {
    html += `<div style="margin-top: 20px;">
              <p><strong>Asiento de Cierre Sugerido:</strong></p>
              <p>Para cerrar las cuentas de resultado a Patrimonio:</p>
              <ul>
                <li>Debe: Cuentas de Ingresos por $${totalIngresos.toFixed(2)}</li>
                <li>Haber: Cuentas de Gastos y Costos por ${(totalGastos + totalCostos + totalCostosSoftware).toFixed(2)}</li>
                <li>Haber/Debe: Resultado del Ejercicio por $${Math.abs(resultadoEjercicio).toFixed(2)}</li>
              </ul>
              <button onclick="generarAsientoCierre(${totalIngresos}, ${totalGastos}, ${totalCostos}, ${totalCostosSoftware}, ${resultadoEjercicio}, '${periodo}')">
                Generar Asiento de Cierre Automático
              </button>
             </div>`;
  }
  
  document.getElementById('resultadoCierre').innerHTML = html;
}

// Función para generar asiento de cierre automático
async function generarAsientoCierre(ingresos, gastos, costos, costosSoftware, resultado, periodo) {
  const fecha = new Date().toISOString().split('T')[0];
  const descripcion = `Cierre contable - ${periodo}`;
  
  // Aquí podrías guardar el asiento de cierre automáticamente
  // Por ahora solo mostramos el asiento sugerido
  alert(`Asiento de cierre generado para ${periodo}\n\nPuede registrarlo manualmente en transacciones:\n\nDescripción: ${descripcion}\nFecha: ${fecha}\n\nNota: Esta funcionalidad de guardado automático requiere integración con la API.`);
}

  </script>
</body>
</html>