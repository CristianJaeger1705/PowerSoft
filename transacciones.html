<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Powersoft - Transacciones</title>
  <link rel="stylesheet" href="estilos.css" />
  <style>
    .project-section {
      background-color: #f0f8ff;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    .project-section label {
      display: inline-block;
      margin-right: 15px;
    }
  </style>
</head>
<body>
  <div class="topbar"><div>Registro de transacciones</div><div><a href="index.html">Menú</a></div></div>
  <main class="container">
    <section class="card">
      <h3>Nuevo asiento (entrada en diario)</h3>
      <form id="journalForm">
        <label>Fecha<input type="date" id="jDate" required /></label>
        <label>Descripción<input id="jDesc" required /></label>
        
        <div class="project-section">
          <h4>Información del Proyecto (Opcional)</h4>
          <label>Proyecto<input id="jProject" /></label>
          <label>Método de Costeo
            <select id="jCostMethod">
              <option value="">No aplica</option>
              <option value="casos_uso">Casos de Uso</option>
              <option value="ifpug">IFPUG</option>
            </select>
          </label>
          <label>Puntos de Función<input type="number" id="jFunctionPoints" step="1" /></label>
        </div>
        
        <div id="entries">
          <!-- entry rows -->
        </div>
        <button type="button" id="addEntry">Agregar línea</button>
        <div class="row">
          <button type="submit">Guardar asiento</button>
        </div>
        <div id="jmsg" class="msg"></div>
      </form>
    </section>

    <section class="card">
      <h3>Asientos registrados</h3>
      <div class="filters">
        <label>Filtrar por proyecto: 
          <select id="projectFilter">
            <option value="">Todos</option>
          </select>
        </label>
        <label>Filtrar por fecha: 
          <input type="date" id="dateFromFilter" /> a <input type="date" id="dateToFilter" />
        </label>
        <button type="button" id="applyFilters">Aplicar filtros</button>
      </div>
      <table id="journalTable">
        <thead><tr><th>Fecha</th><th>Descripción</th><th>Proyecto</th><th>Débito</th><th>Crédito</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <!-- NUEVA SECCIÓN: REGISTRO DE COSTOS POR PROYECTO -->
<section class="card">
  <h3>Registro de Costos por Proyecto</h3>
  <form id="costForm">
    <label>Proyecto: 
      <select id="costProject" required>
        <option value="">Seleccionar proyecto</option>
      </select>
    </label>
    
    <label>Tipo de Costo:
      <select id="costType" required>
        <option value="">Seleccionar tipo</option>
        <option value="directo">Costo Directo</option>
        <option value="indirecto">Costo Indirecto (CIF)</option>
      </select>
    </label>
    
    <label>Categoría de Costo:
      <select id="costCategory" required>
        <option value="">Seleccionar categoría</option>
      </select>
    </label>
    
    <label>Descripción: <input type="text" id="costDesc" required></label>
    <label>Monto: $<input type="number" id="costAmount" step="0.01" required></label>
    <label>Fecha: <input type="date" id="costDate" required></label>
    
    <button type="submit">Registrar Costo</button>
  </form>
  <div id="costMsg" class="msg"></div>
</section>

<!-- SECCIÓN: ASIGNACIÓN AUTOMÁTICA DE CIF -->
<section class="card">
  <h3>Asignación de Costos Indirectos (CIF)</h3>
  <button onclick="distribuirCIF()">Distribuir CIF a Proyectos</button>
  <div id="cifResults"></div>
</section>


<script>
const API = 'http://localhost:3000';
if (!sessionStorage.getItem('ps_user')) location.href = 'login.html';

async function getAccounts() {
  const res = await fetch(API + '/accounts');
  return await res.json();
}

// gestionar entradas
const entriesContainer = document.getElementById('entries');
function createEntryRow(data = {}) {
  const div = document.createElement('div');
  div.className = 'entryRow';
  div.innerHTML = `
    <select class="accSelect"></select>
    <input type="number" class="debit" placeholder="Debe" step="0.01" />
    <input type="number" class="credit" placeholder="Haber" step="0.01" />
    <button type="button" class="rm">X</button>
  `;
  entriesContainer.appendChild(div);
  populateSelect(div.querySelector('.accSelect'));
  if (data.accountId) div.querySelector('.accSelect').value = data.accountId;
  if (data.debit) div.querySelector('.debit').value = data.debit;
  if (data.credit) div.querySelector('.credit').value = data.credit;
  div.querySelector('.rm').addEventListener('click', ()=>div.remove());
}

async function populateSelect(sel) {
  const accounts = await getAccounts();
  sel.innerHTML = accounts.map(a=>`<option value="${a.id}">${a.code} - ${a.name}</option>`).join('');
}

document.getElementById('addEntry').addEventListener('click', ()=>createEntryRow());
// iniciar con 2 filas
entriesContainer.innerHTML = ''; createEntryRow(); createEntryRow();

const journalTableBody = document.querySelector('#journalTable tbody');

// FUNCION CENTRAL: traer y filtrar journals (cliente)
async function fetchJournals(filters = {}) {
  try {
    const url = API + '/journals?_sort=date,id&_order=desc';
    console.log('[fetchJournals] URL:', url, 'filters:', filters);
    const res = await fetch(url);
    let list = await res.json();

    // filtro por proyecto (exacto)
    if (filters.project) {
      list = list.filter(j => (j.project || '') === filters.project);
    }

    // filtro por dateFrom (>=)
    if (filters.dateFrom) {
      const from = new Date(filters.dateFrom); // inicio del día local
      from.setHours(0,0,0,0);
      list = list.filter(j => {
        const jd = new Date(j.date);
        return jd >= from;
      });
    }

    // filtro por dateTo (<= inclusive, hasta 23:59:59.999)
    if (filters.dateTo) {
      const to = new Date(filters.dateTo);
      to.setHours(23,59,59,999);
      list = list.filter(j => {
        const jd = new Date(j.date);
        return jd <= to;
      });
    }

    // render tabla
    journalTableBody.innerHTML = '';
    for (const j of list) {
      const totalDebit = (j.entries || []).reduce((s,e)=>s+ (e.debit || 0),0);
      const totalCredit = (j.entries || []).reduce((s,e)=>s+ (e.credit || 0),0);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${j.date}</td><td>${j.desc}</td><td>${j.project || ''}</td><td>${totalDebit.toFixed(2)}</td><td>${totalCredit.toFixed(2)}</td>
        <td><button data-id="${j.id}" class="del">Eliminar</button></td>`;
      journalTableBody.appendChild(tr);
    }

    console.log('[fetchJournals] registros mostrados:', list.length);
  } catch (err) {
    console.error('Error fetchJournals:', err);
  }
}

// Cargar proyectos para el filtro (única definición)
async function loadProjects() {
  try {
    const res = await fetch(API + '/journals');
    const journals = await res.json();
    const projects = [...new Set(journals.map(j => j.project).filter(p => p))];
    const select = document.getElementById('projectFilter');
    select.innerHTML = '<option value="">Todos</option>' + projects.map(p => `<option value="${p}">${p}</option>`).join('');
  } catch (err) {
    console.error('Error loadProjects:', err);
  }
}

// Guardar asiento (una sola listener)
document.getElementById('journalForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const date = document.getElementById('jDate').value;
  const desc = document.getElementById('jDesc').value.trim();
  const project = document.getElementById('jProject').value.trim();
  const costMethod = document.getElementById('jCostMethod').value;
  const functionPoints = document.getElementById('jFunctionPoints').value;

  const rows = Array.from(document.querySelectorAll('.entryRow'));
  const entries = rows.map(r => {
    return {
      accountId: r.querySelector('.accSelect').value,
      debit: parseFloat(r.querySelector('.debit').value) || 0,
      credit: parseFloat(r.querySelector('.credit').value) || 0
    };
  }).filter(en => en.debit > 0 || en.credit > 0);

  const totalDebit = entries.reduce((s, e) => s + e.debit, 0);
  const totalCredit = entries.reduce((s, e) => s + e.credit, 0);
  const msg = document.getElementById('jmsg');
  msg.textContent = '';

  if (Math.abs(totalDebit - totalCredit) > 0.001) {
    msg.textContent = 'Asiento no balanceado: Debe debe igualar Haber.';
    msg.style.color = 'crimson';
    return;
  }

  const payload = { 
    date, 
    desc, 
    entries,
    project: project || null,
    costMethod: costMethod || null,
    functionPoints: functionPoints ? parseInt(functionPoints) : null
  };

  try {
    const r = await fetch(API + '/journals', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    if (!r.ok) throw new Error('Error en POST: ' + r.status);
    document.getElementById('journalForm').reset();
    entriesContainer.innerHTML = '';
    createEntryRow(); createEntryRow();
    msg.textContent = 'Asiento guardado.';
    msg.style.color = 'green';
    await fetchJournals();
    await loadProjects();
  } catch (error) {
    msg.textContent = 'Error al guardar el asiento.';
    msg.style.color = 'crimson';
    console.error('Error:', error);
  }
});

// Eliminar asiento (delegación)
journalTableBody.addEventListener('click', async (e) => {
  if (e.target.matches('.del')) {
    if (!confirm('Eliminar asiento?')) return;
    const id = e.target.dataset.id;
    try {
      const r = await fetch(API + '/journals/' + id, { method:'DELETE' });
      if (!r.ok) throw new Error('Delete failed ' + r.status);
      await fetchJournals();
      await loadProjects();
    } catch (err) {
      console.error('Error al eliminar:', err);
    }
  }
});

// Aplicar filtros (único listener)
document.getElementById('applyFilters').addEventListener('click', () => {
  const project = document.getElementById('projectFilter').value;
  const dateFrom = document.getElementById('dateFromFilter').value;
  const dateTo = document.getElementById('dateToFilter').value;

  console.log('[applyFilters] valores:', { project, dateFrom, dateTo });

  // Validaciones simples
  if (dateTo && !dateFrom) {
    alert('Por favor, seleccione una fecha de inicio si especifica una fecha final');
    return;
  }
  if (dateFrom && dateTo && dateTo < dateFrom) {
    alert('La fecha final no puede ser anterior a la fecha inicial');
    return;
  }

  fetchJournals({ project: project || '', dateFrom: dateFrom || '', dateTo: dateTo || '' });
});

// Botón limpiar filtros (opcional)
(function addClearFiltersButton() {
  const filtersDiv = document.querySelector('.filters');
  if (document.getElementById('clearFilters')) return;
  const clearButton = document.createElement('button');
  clearButton.textContent = 'Limpiar filtros';
  clearButton.type = 'button';
  clearButton.id = 'clearFilters';
  clearButton.style.marginLeft = '10px';
  clearButton.addEventListener('click', () => {
    document.getElementById('projectFilter').value = '';
    document.getElementById('dateFromFilter').value = '';
    document.getElementById('dateToFilter').value = '';
    fetchJournals();
  });
  filtersDiv.appendChild(clearButton);
})();

// Cargar inicial
fetchJournals();
loadProjects();

// Cargar transacción desde costeo (igual que antes)
function cargarTransaccionDesdeCosteo() {
  const transaccionGuardada = localStorage.getItem('ultimaTransaccionCosteo');
  if (transaccionGuardada) {
    const transaccion = JSON.parse(transaccionGuardada);
    if (confirm(`¿Desea cargar la transacción del proyecto "${transaccion.proyecto}" por $${transaccion.precioVenta.toFixed(2)}?`)) {
      document.getElementById('jDate').value = transaccion.fecha;
      document.getElementById('jDesc').value = `Venta de software - ${transaccion.proyecto}`;
      document.getElementById('jProject').value = transaccion.proyecto;
      document.getElementById('jCostMethod').value = 'ifpug';
      document.getElementById('jFunctionPoints').value = transaccion.puntosFuncion;
      localStorage.removeItem('ultimaTransaccionCosteo');
    }
  }
}
window.addEventListener('load', cargarTransaccionDesdeCosteo);

//////////////////////////////////////////////////////////////////////////
// ========== SISTEMA DE GESTIÓN DE COSTOS ==========

// Cargar categorías de costo
async function loadCostCategories() {
  try {
    const res = await fetch(API + '/cost_categories');
    return await res.json();
  } catch (error) {
    console.error('Error cargando categorías:', error);
    return [];
  }
}

// Cargar proyectos para select
async function loadProjectsForCosts() {
  const res = await fetch(API + '/journals');
  const journals = await res.json();
  const projects = [...new Set(journals.map(j => j.project).filter(p => p))];
  
  const select = document.getElementById('costProject');
  select.innerHTML = '<option value="">Seleccionar proyecto</option>' + 
    projects.map(p => `<option value="${p}">${p}</option>`).join('');
}

// Cargar categorías según tipo seleccionado
document.getElementById('costType').addEventListener('change', async function() {
  const type = this.value;
  const categories = await loadCostCategories();
  const filtered = categories.filter(c => c.type === type);
  
  const select = document.getElementById('costCategory');
  select.innerHTML = '<option value="">Seleccionar categoría</option>' + 
    filtered.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
});

// Registrar nuevo costo
document.getElementById('costForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const costData = {
    project: document.getElementById('costProject').value,
    cost_category_id: document.getElementById('costCategory').value,
    amount: parseFloat(document.getElementById('costAmount').value),
    date: document.getElementById('costDate').value,
    description: document.getElementById('costDesc').value,
    type: document.getElementById('costType').value
  };

  try {
    const res = await fetch(API + '/project_costs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(costData)
    });

    if (res.ok) {
      document.getElementById('costMsg').textContent = 'Costo registrado exitosamente';
      document.getElementById('costMsg').style.color = 'green';
      document.getElementById('costForm').reset();
    }
  } catch (error) {
    document.getElementById('costMsg').textContent = 'Error registrando costo';
    document.getElementById('costMsg').style.color = 'crimson';
  }
});

// ========== DISTRIBUCIÓN AUTOMÁTICA DE CIF ==========

async function distribuirCIF() {
  // 1. Obtener costos indirectos del período
  const costsRes = await fetch(API + '/project_costs?type=indirecto');
  const indirectCosts = await costsRes.json();
  
  // 2. Obtener proyectos activos
  const journalsRes = await fetch(API + '/journals');
  const journals = await journalsRes.json();
  const projects = [...new Set(journals.map(j => j.project).filter(p => p))];
  
  // 3. Calcular base de distribución (horas por proyecto)
  const projectHours = {};
  projects.forEach(project => {
    // Simular horas - en realidad esto vendría de timesheets
    projectHours[project] = Math.random() * 200 + 100; // 100-300 horas
  });
  
  // 4. Calcular total de horas
  const totalHours = Object.values(projectHours).reduce((a, b) => a + b, 0);
  
  // 5. Calcular total CIF
  const totalCIF = indirectCosts.reduce((sum, cost) => sum + cost.amount, 0);
  
  // 6. Distribuir CIF
  let resultsHTML = `<h4>Distribución de CIF - Total: $${totalCIF.toFixed(2)}</h4>`;
  resultsHTML += '<table style="width:100%; border-collapse:collapse; margin-top:10px;">';
  resultsHTML += '<tr style="background:#003366; color:white;"><th>Proyecto</th><th>Horas</th><th>% Distribución</th><th>CIF Asignado</th></tr>';
  
  for (const project of projects) {
    const hours = projectHours[project];
    const percentage = (hours / totalHours) * 100;
    const cifAssigned = (totalCIF * percentage) / 100;
    
    resultsHTML += `
      <tr>
        <td style="border:1px solid #ccc; padding:8px;">${project}</td>
        <td style="border:1px solid #ccc; padding:8px;">${hours.toFixed(0)}</td>
        <td style="border:1px solid #ccc; padding:8px;">${percentage.toFixed(2)}%</td>
        <td style="border:1px solid #ccc; padding:8px;">$${cifAssigned.toFixed(2)}</td>
      </tr>
    `;
  }
  
  resultsHTML += '</table>';
  document.getElementById('cifResults').innerHTML = resultsHTML;
}

// ========== INICIALIZACIÓN ==========

// Agregar esta llamada a la inicialización existente
async function initializeCostSystem() {
  await loadProjectsForCosts();
  await loadCostCategories();
}

// Llamar después de que cargue la página
setTimeout(initializeCostSystem, 1000);

</script>



</body>
</html>